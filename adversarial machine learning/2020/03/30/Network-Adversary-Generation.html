<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Network Adversary Generator | Adversarial Wilderness</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Network Adversary Generator" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A Pytorch implementation of Network Adversary Generator CVPR 2018." />
<meta property="og:description" content="A Pytorch implementation of Network Adversary Generator CVPR 2018." />
<link rel="canonical" href="https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html" />
<meta property="og:url" content="https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html" />
<meta property="og:site_name" content="Adversarial Wilderness" />
<meta property="og:image" content="https://gokkulnath.github.io/adversarialwilderness/images/Collage_perturbation.v1.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"A Pytorch implementation of Network Adversary Generator CVPR 2018.","headline":"Network Adversary Generator","dateModified":"2020-03-30T00:00:00-05:00","datePublished":"2020-03-30T00:00:00-05:00","@type":"BlogPosting","image":"https://gokkulnath.github.io/adversarialwilderness/images/Collage_perturbation.v1.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html"},"url":"https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/adversarialwilderness/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://gokkulnath.github.io/adversarialwilderness/feed.xml" title="Adversarial Wilderness" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-149929011-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/adversarialwilderness/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Network Adversary Generator | Adversarial Wilderness</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Network Adversary Generator" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A Pytorch implementation of Network Adversary Generator CVPR 2018." />
<meta property="og:description" content="A Pytorch implementation of Network Adversary Generator CVPR 2018." />
<link rel="canonical" href="https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html" />
<meta property="og:url" content="https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html" />
<meta property="og:site_name" content="Adversarial Wilderness" />
<meta property="og:image" content="https://gokkulnath.github.io/adversarialwilderness/images/Collage_perturbation.v1.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-30T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"A Pytorch implementation of Network Adversary Generator CVPR 2018.","headline":"Network Adversary Generator","dateModified":"2020-03-30T00:00:00-05:00","datePublished":"2020-03-30T00:00:00-05:00","@type":"BlogPosting","image":"https://gokkulnath.github.io/adversarialwilderness/images/Collage_perturbation.v1.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html"},"url":"https://gokkulnath.github.io/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://gokkulnath.github.io/adversarialwilderness/feed.xml" title="Adversarial Wilderness" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-149929011-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/adversarialwilderness/">Adversarial Wilderness</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/adversarialwilderness/about/">About Me</a><a class="page-link" href="/adversarialwilderness/research/">Research Ideas</a><a class="page-link" href="/adversarialwilderness/search/">Search</a><a class="page-link" href="/adversarialwilderness/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Network Adversary Generator</h1><p class="page-description">A Pytorch implementation of Network Adversary Generator CVPR 2018.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-30T00:00:00-05:00" itemprop="datePublished">
        Mar 30, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      21 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/adversarialwilderness/categories/#Adversarial Machine learning">Adversarial Machine learning</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          
          
          
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Introduction">Introduction </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Paper-Abstract:">Paper Abstract: </a></li>
<li class="toc-entry toc-h4"><a href="#Motivation">Motivation </a></li>
<li class="toc-entry toc-h4"><a href="#Key-Results:">Key Results: </a></li>
<li class="toc-entry toc-h4"><a href="#Aproach">Aproach </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Code:">Code: </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Data-Preparation">Data Preparation </a></li>
<li class="toc-entry toc-h3"><a href="#Code-Below-Assumes-Dataset-is-downlaoded-and-setup">Code Below Assumes Dataset is downlaoded and setup </a>
<ul>
<li class="toc-entry toc-h5"><a href="#Verify-Dataset">Verify Dataset </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Imports">Imports </a></li>
<li class="toc-entry toc-h3"><a href="#Dataset-and-Dataloaders-Setup">Dataset and Dataloaders Setup </a></li>
<li class="toc-entry toc-h3"><a href="#Transforms">Transforms </a></li>
<li class="toc-entry toc-h3"><a href="#Dataset-and-Dataloaders">Dataset and Dataloaders </a></li>
<li class="toc-entry toc-h3"><a href="#Loss-Functions/Objectives">Loss Functions/Objectives </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Self-Note:">Self Note: </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Generator">Generator </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Debugging">Debugging </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Setting-up-Discriminator-:-Model-:-Architecture">Setting up Discriminator : Model : Architecture </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Run-only-once-:">Run only once : </a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#Choice-of-Hyperparameters">Choice of Hyperparameters </a></li>
<li class="toc-entry toc-h3"><a href="#Other-Utils">Other Utils </a>
<ul>
<li class="toc-entry toc-h4"><a href="#Validating-Model-Utils">Validating Model Utils </a></li>
<li class="toc-entry toc-h4"><a href="#Setup-Wandb">Setup Wandb </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#Fit-and-Train-the-Generator">Fit and Train the Generator </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Start-Actual-Trainning">Start Actual Trainning </a></li>
<li class="toc-entry toc-h1"><a href="#Misc:">Misc: </a>
<ul>
<li class="toc-entry toc-h5"><a href="#Setup-Caffenet-and-VGG-F--(TODO)">Setup Caffenet and VGG-F  (TODO) </a></li>
<li class="toc-entry toc-h4"><a href="#Run-the-below-code-first-before-loading-VGG-F">Run the below code first before loading VGG-F </a></li>
<li class="toc-entry toc-h4"><a href="#Loading-VGG-F">Loading VGG-F </a></li>
<li class="toc-entry toc-h3"><a href="#Downloading-Trained-Weights">Downloading Trained Weights </a></li>
<li class="toc-entry toc-h3"><a href="#Evaluating-NAG-performance-across-Models:-(TODO)">Evaluating NAG performance across Models: (TODO) </a></li>
<li class="toc-entry toc-h3"><a href="#Interpolating-Latent-Dimension-for-NAG">Interpolating Latent Dimension for NAG </a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#Obtained-Perturbations">Obtained Perturbations </a>
<ul>
<li class="toc-entry toc-h2"><a href="#References:">References: </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-03-30-Network-Adversary-Generation.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Paper-Abstract:">
<a class="anchor" href="#Paper-Abstract:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Paper Abstract:<a class="anchor-link" href="#Paper-Abstract:"> </a>
</h4>
<p>Adversarial perturbations can pose a serious threat for deploying machine learning systems. Recent works have shown existence of image-agnostic perturbations that can fool classifiers over most natural images. Existing methods present optimization approaches that solve for a fooling objective with an imperceptibility constraint to craft the perturbations making it very hard to defend.</p>
<h4 id="Motivation">
<a class="anchor" href="#Motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Motivation<a class="anchor-link" href="#Motivation"> </a>
</h4>
<p>Current Approaches for crafting adversaries for a given classifier generate only one perturbation at a time, which is a single instance from the manifold of adversarial perturbations. In order to build robust models, it is essential to explore diverse manifold of adversarial perturbations. This work can be of very useful, when we are using adversarial trainning, where the cost of generation of adversaries is high(Depends on the attack). With this approach, we will be able to generate adversarial noises from the learned distribution of adversarial perturbations.</p>
<h4 id="Key-Results:">
<a class="anchor" href="#Key-Results:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Key Results:<a class="anchor-link" href="#Key-Results:"> </a>
</h4>
<p>The author's demonstrate that perturbations crafted by this model</p>
<ol>
<li>achieve state-of-the-art fooling rates</li>
<li>exhibit wide variety </li>
<li>deliver excellent cross model generalizability.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Aproach">
<a class="anchor" href="#Aproach" aria-hidden="true"><span class="octicon octicon-link"></span></a>Aproach<a class="anchor-link" href="#Aproach"> </a>
</h4>
<p>The architecture of the proposed model is inspired from that of GANs and is trained using fooling and diversity objectives. The trained generator network attempts to capture the distribution of adversarial perturbations for a given classifier and readily
generates a wide variety of such perturbations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/adversarialwilderness/images/copied_from_nb/resources/nag.png" alt="Proposed approach"></p>
<ul>
<li><strong>Core idea is to model the distribution of universal adversarial perturbations for a given classifier.</strong></li>
<li>The image shows a batch of B random vectors {z}<sub>B</sub> transforming into perturbations {delta}<sub>B</sub> by G which get added to the batch of data samples {x}<sub>B</sub>.</li>
<li>The top portion shows adversarial batch (X<sub>A</sub>), bottom portion shows shuffled adversarial batch (X<sub>S</sub>) and middle portion shows the benign batch (X<sub>B</sub>). The Fooling objective <strong>Lf</strong> and Diversity objective <strong>Ld</strong> constitute the loss. </li>
<li>
<strong>Note:</strong> The target CNN (f) is a trained classifier and its parameters are not updated during the proposed training. On the other hand, the parameters of generator (G) are randomly initialized and learned through backpropagating the loss. (Best viewed in color).</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Code:">
<a class="anchor" href="#Code:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code:<a class="anchor-link" href="#Code:"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Data-Preparation">
<a class="anchor" href="#Data-Preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Data Preparation<a class="anchor-link" href="#Data-Preparation"> </a>
</h3>
<ul>
<li>Download of Dataset 
<strong>P.S</strong>: Randomly Sampled 10 instances from each target class as described in the paper.</li>
<li>Option 1: Download from Archive.org<ul>
<li><a href="https://archive.org/details/Imagenet_NAG">Archive Link</a></li>
<li><a href="https://archive.org/download/Imagenet_NAG/train.zip">train.zip</a></li>
<li><a href="https://archive.org/download/Imagenet_NAG/valid.zip">valid.zip</a></li>
</ul>
</li>
<li>Option 2 : Mega Download Link for Train abd Validation data of Imagenet 2012 (Obtained from Kaggle)<ul>
<li>Validation Data: <a href="https://mega.nz/#!yDoTDIyD!RjN6OBA92-KLpNqDeLS3OzwmAYesEbTsiQat9hT6p6s">Mega Link</a>
</li>
<li>Trainning Data: <a href="https://mega.nz/#!vKY0WSDa!4aibnBkiXUrO9MkhQlLGXac7wLF5HY7O4LzfdFEaeQU">Mega Link</a> <!-- - If link fails to work use the following Colab notebook to generate your own subset of trainning examples. [Link](https://colab.research.google.com/drive/1LbZBfgqntWb3HuC3UFyF_FvwnHtd1xTA) -->
</li>
</ul>
</li>
<li>Setting up of Folder Structure
For Easier handling and reproducibility of results download from mega link </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Code-Below-Assumes-Dataset-is-downlaoded-and-setup">
<a class="anchor" href="#Code-Below-Assumes-Dataset-is-downlaoded-and-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Code Below Assumes Dataset is downlaoded and setup<a class="anchor-link" href="#Code-Below-Assumes-Dataset-is-downlaoded-and-setup"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Verify-Dataset">
<a class="anchor" href="#Verify-Dataset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Verify Dataset<a class="anchor-link" href="#Verify-Dataset"> </a>
</h5>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="n">train_ok</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">val_ok</span> <span class="o">=</span> <span class="kc">True</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Training Data Verification"</span><span class="p">)</span>
<span class="n">cls_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s2">"ILSVRC/train/*"</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Total Number of Classes: </span><span class="si">{}</span><span class="s2"> in train directory"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cls_count</span><span class="p">))</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">cls_</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s2">"ILSVRC/train/*"</span><span class="p">):</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">cls_</span> <span class="o">+</span> <span class="s2">"/*"</span><span class="p">)</span>
    <span class="n">img_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="n">img_count</span>
    <span class="k">if</span> <span class="n">img_count</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cls_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_count</span><span class="p">)</span>
        <span class="n">train_ok</span><span class="o">=</span><span class="kc">False</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Total </span><span class="si">{}</span><span class="s2"> number of files in </span><span class="si">{}</span><span class="s2"> classes. i.e 10 Images/Class"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">cls_count</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Validation Data Verification"</span><span class="p">)</span>
<span class="n">val_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s2">"ILSVRC/valid/*"</span><span class="p">)</span>
<span class="n">val_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_files</span><span class="p">)</span>
<span class="k">if</span> <span class="n">val_count</span> <span class="o">==</span> <span class="mi">50000</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Validation Data has correct number of files i.e </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_count</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Validation Data has some issue. Has following number of file : </span><span class="si">{}</span><span class="s2">. Kindly Check!!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_count</span><span class="p">))</span>
    <span class="n">val_ok</span><span class="o">=</span><span class="kc">False</span>
<span class="k">if</span> <span class="n">train_ok</span> <span class="ow">and</span> <span class="n">val_ok</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Dataset is Setup Correctly"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Training Data Verification
Total Number of Classes: 1000 in train directory
Total 10000 number of files in 1000 classes. i.e 10 Images/Class
Validation Data Verification
Validation Data has correct number of files i.e 50000
Dataset is Setup Correctly
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Imports">
<a class="anchor" href="#Imports" aria-hidden="true"><span class="octicon octicon-link"></span></a>Imports<a class="anchor-link" href="#Imports"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span><span class="n">Dataset</span>

<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.models</span> <span class="k">as</span> <span class="nn">tvm</span>

<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets.folder</span> <span class="kn">import</span> <span class="n">DatasetFolder</span><span class="p">,</span><span class="n">ImageFolder</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">gc</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span><span class="nn">random</span><span class="o">,</span><span class="nn">string</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ngpu</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span> <span class="k">if</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ngpu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Using Pytorch Version : </span><span class="si">{}</span><span class="s2"> and Torchvision Version : </span><span class="si">{}</span><span class="s2">. Using Device </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span><span class="n">torchvision</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span><span class="n">device</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using Pytorch Version : 1.4.0 and Torchvision Version : 0.5.0. Using Device cuda
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dataset-and-Dataloaders-Setup">
<a class="anchor" href="#Dataset-and-Dataloaders-Setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dataset and Dataloaders Setup<a class="anchor-link" href="#Dataset-and-Dataloaders-Setup"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset_path</span><span class="o">=</span><span class="sa">r</span><span class="s1">'ILSVRC/'</span>
<span class="n">train_dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="o">+</span><span class="s1">'train'</span>
<span class="n">test_dataset_path</span><span class="o">=</span><span class="n">dataset_path</span><span class="o">+</span><span class="s1">'valid'</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Dataset root Folder:</span><span class="si">{}</span><span class="s2">. Train Data Path: </span><span class="si">{}</span><span class="s2">. Validation Data Path </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span><span class="n">train_dataset_path</span><span class="p">,</span><span class="n">test_dataset_path</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Dataset root Folder:ILSVRC/. Train Data Path: ILSVRC/train. Validation Data Path ILSVRC/valid
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Preparation of Labels </span>
<span class="n">label_dict</span><span class="o">=</span><span class="p">{}</span>
<span class="n">label_idx</span><span class="o">=</span><span class="p">{}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'ILSVRC/LOC_synset_mapping.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">lines</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">label</span><span class="p">,</span><span class="n">actual</span> <span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">label_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">=</span><span class="n">actual</span>
        <span class="n">label_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">=</span><span class="n">idx</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Transforms">
<a class="anchor" href="#Transforms" aria-hidden="true"><span class="octicon octicon-link"></span></a>Transforms<a class="anchor-link" href="#Transforms"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># transforms</span>
<span class="n">size</span><span class="o">=</span><span class="mi">224</span>
<span class="c1"># Imagenet Stats</span>
<span class="n">vgg_mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">103.939</span><span class="p">,</span> <span class="mf">116.779</span><span class="p">,</span> <span class="mf">123.68</span><span class="p">]</span>

<span class="n">preprocess</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">)),</span>
                               <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                               <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vgg_mean</span><span class="p">,(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dataset-and-Dataloaders">
<a class="anchor" href="#Dataset-and-Dataloaders" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dataset and Dataloaders<a class="anchor-link" href="#Dataset-and-Dataloaders"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CustomDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">=</span><span class="n">transform</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="o">=</span><span class="n">subset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="o">==</span><span class="s1">'train'</span><span class="p">:</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="o">=</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">/*/*'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span><span class="s1">'valid'</span><span class="p">:</span>
            <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'ILSVRC/LOC_val_solution.csv'</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'PredictionString'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'PredictionString'</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="o">=</span><span class="s1">'ILSVRC/valid/'</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">'ImageId'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="s1">'.JPEG'</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'label'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Number of instances in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="si">}</span><span class="s2"> subset of Dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>       

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">image</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">getbands</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'L'</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>    
        <span class="k">return</span> <span class="n">image</span><span class="p">,</span><span class="n">label_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_fn</span><span class="p">)</span>
        
<span class="n">data_train</span><span class="o">=</span><span class="n">ImageFolder</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'ILSVRC/train'</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">preprocess</span><span class="p">)</span>
<span class="n">class2idx</span><span class="o">=</span><span class="n">data_train</span><span class="o">.</span><span class="n">class_to_idx</span>
<span class="n">data_valid</span><span class="o">=</span><span class="n">CustomDataset</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">'valid'</span><span class="p">,</span><span class="n">root_dir</span><span class="o">=</span><span class="n">dataset_path</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">preprocess</span><span class="p">)</span>

<span class="n">train_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
<span class="n">val_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> Number of instances in valid subset of Dataset: 50000
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Loss-Functions/Objectives">
<a class="anchor" href="#Loss-Functions/Objectives" aria-hidden="true"><span class="octicon octicon-link"></span></a>Loss Functions/Objectives<a class="anchor-link" href="#Loss-Functions/Objectives"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fooling_objective</span><span class="p">(</span><span class="n">qc_</span><span class="p">):</span>
    <span class="sd">'''Helper function to computer compute -log(1-qc'), </span>
<span class="sd">    where qc' is the adversarial probability of the class having </span>
<span class="sd">    maximum probability in the corresponding clean probability</span>
<span class="sd">    qc' ---&gt; qc_</span>
<span class="sd">    Parameters: </span>
<span class="sd">    prob_vec : Probability vector for the clean batch</span>
<span class="sd">    adv_prob_vec : Probability vecotr of the adversarial batch</span>
<span class="sd">    Returns: </span>
<span class="sd">    -log(1-qc') , qc'</span>
<span class="sd">    </span>
<span class="sd">    '''</span>  
    <span class="c1"># Get the largest probablities from predictions : Shape (bs,1)</span>
    <span class="n">qc_</span><span class="o">=</span><span class="n">qc_</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qc_</span><span class="p">)</span> <span class="p">,</span> <span class="n">qc_</span>

<span class="k">def</span> <span class="nf">diversity_objective</span><span class="p">(</span><span class="n">prob_vec_no_shuffle</span><span class="p">,</span> <span class="n">prob_vec_shuffled</span><span class="p">):</span>
    <span class="sd">'''Helper function to calculate the cosine distance between two probability vectors</span>
<span class="sd">    Parameters: </span>
<span class="sd">    prob_vec : Probability vector for the clean batch</span>
<span class="sd">    adv_prob_vec : Probability vector for the adversarial batch</span>
<span class="sd">    Returns : </span>
<span class="sd">    Cosine distance between the corresponding clean and adversarial batches</span>
<span class="sd">    '''</span>    
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">prob_vec_no_shuffle</span><span class="p">,</span><span class="n">prob_vec_shuffled</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1">## TODO : Not Required. As we always take the last layer.</span>

<span class="k">def</span> <span class="nf">intermediate_activation_objective</span><span class="p">(</span><span class="n">layer_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">''' Extract the activations of any intermediate layer for:</span>
<span class="sd">    1. batch of images (of batch size=32) corrupted by the perturbations (of batch size=32) </span>
<span class="sd">    2. same batch of images corrupted by same batch of perturbations but in different (random) order</span>
<span class="sd">    (in this case the intermdeiate layer is set to 'res4f' of ResNet 50 architecture)</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="n">arch</span> <span class="o">==</span><span class="s1">'resnet50'</span><span class="p">:</span>
        <span class="n">layer_name</span><span class="o">=</span><span class="s1">'res4f'</span>
    
    <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Self-Note:">
<a class="anchor" href="#Self-Note:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Self Note:<a class="anchor-link" href="#Self-Note:"> </a>
</h4>
<ul>
<li>Effect of ConvTranspose2d : It is a combination of upsampling and convolution layers used to increase the spatial resolution of the tensor</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Generator">
<a class="anchor" href="#Generator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generator<a class="anchor-link" href="#Generator"> </a>
</h3>
<ul>
<li>Architecture of the generator (G) unchanged for different target CNN architectures</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/adversarialwilderness/images/copied_from_nb/resources/DCGAN.png" alt="DCGAN"></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="n">ngf</span><span class="o">=</span><span class="mi">128</span>
<span class="n">nz</span><span class="o">=</span> <span class="n">latent_dim</span><span class="o">=</span><span class="mi">10</span>
<span class="n">e_lim</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nc</span><span class="o">=</span><span class="mi">3</span> <span class="c1"># Number of Channels</span>

<span class="c1"># Fixed Architecture: Weights will be updated by Backprop.</span>
<span class="k">class</span> <span class="nc">AdveraryGenerator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e_lim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AdveraryGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_lim</span> <span class="o">=</span> <span class="n">e_lim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span> <span class="n">in_channels</span><span class="o">=</span><span class="n">nz</span><span class="p">,</span><span class="n">out_channels</span><span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="c1"># state size. (ngf*8) x 4 x 4</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="c1"># state size. (ngf*4) x 8 x 8</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="c1"># state size. (ngf*2) x 16 x 16</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="c1"># state size. (ngf) x 32 x 32</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="c1"># state size. (nc) x 64 x 64</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_lim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># Scaling of Îµ</span>
    
<span class="c1"># move Generator to GPU if available</span>
<span class="n">adversarygen</span><span class="o">=</span><span class="n">AdveraryGenerator</span><span class="p">(</span><span class="n">e_lim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Debugging">
<a class="anchor" href="#Debugging" aria-hidden="true"><span class="octicon octicon-link"></span></a>Debugging<a class="anchor-link" href="#Debugging"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">torchsummary</span> <span class="kn">import</span> <span class="n">summary</span>
        <span class="n">summary</span><span class="p">(</span><span class="n">adversarygen</span><span class="p">,(</span><span class="n">nz</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="s1">'Check torchsummary is installed. If not install using the command pip install torchsummary'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setting-up-Discriminator-:-Model-:-Architecture">
<a class="anchor" href="#Setting-up-Discriminator-:-Model-:-Architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up Discriminator : Model : Architecture<a class="anchor-link" href="#Setting-up-Discriminator-:-Model-:-Architecture"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="n">googlenet</span><span class="p">,</span> <span class="n">vgg16</span> <span class="p">,</span> <span class="n">vgg19</span><span class="p">,</span> <span class="n">resnet152</span><span class="p">,</span> <span class="n">resnet50</span>


<span class="n">model_dict</span> <span class="o">=</span><span class="p">{</span>
    <span class="s1">'googlenet'</span><span class="p">:</span> <span class="n">googlenet</span><span class="p">,</span>
    <span class="s1">'vgg16'</span><span class="p">:</span> <span class="n">vgg16</span> <span class="p">,</span>
    <span class="s1">'vgg19'</span><span class="p">:</span><span class="n">vgg19</span><span class="p">,</span> 
    <span class="s1">'resnet152'</span><span class="p">:</span><span class="n">resnet152</span><span class="p">,</span> <span class="c1"># TODO Generate Perturbations</span>
    <span class="s1">'resnet50'</span><span class="p">:</span><span class="n">resnet50</span>    <span class="c1"># TODO Generate Perturbations </span>
    
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Run-only-once-:">
<a class="anchor" href="#Run-only-once-:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run only once :<a class="anchor-link" href="#Run-only-once-:"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="c1"># Get all Pretrained Weights:</span>
<span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">arch</span> <span class="o">!=</span><span class="s1">'vgg-f'</span><span class="p">:</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="n">arch</span><span class="p">](</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Choice-of-Hyperparameters">
<a class="anchor" href="#Choice-of-Hyperparameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Choice of Hyperparameters<a class="anchor-link" href="#Choice-of-Hyperparameters"> </a>
</h3>
<ul>
<li>The architecture of the generator consists of 5 deconv layers. The final deconv layer is followed by a tanh non-linearity and scaling by epsillon (10)</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># epsillon=10</span>
<span class="c1"># batch_size=32</span>
<span class="c1"># latent_dim = 10</span>
<span class="n">img_h</span><span class="p">,</span><span class="n">img_w</span><span class="p">,</span><span class="n">img_c</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">latent_dim</span><span class="o">=</span><span class="mi">10</span>
<span class="n">arch</span><span class="o">=</span><span class="s1">'resnet50'</span>
<span class="n">archs</span><span class="o">=</span><span class="n">model_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="c1"># ['vgg-f','vgg16','vgg19','googlenet','resnet50','resnet152'] </span>

<span class="k">def</span> <span class="nf">get_bs</span><span class="p">(</span><span class="n">arch</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<span class="c1">#         GPU_BENCHMARK= 8192.0</span>
<span class="c1">#         GPU_MAX_MEM = torch.cuda.get_device_properties(device).total_memory / (1024*1024)</span>
<span class="c1">#         BS_DIV= GPU_BENCHMARK/GPU_MAX_MEM</span>
<span class="c1">#         print(f"Current GPU MAX Size : {GPU_MAX_MEM}. {BS_DIV}")</span>

        <span class="k">if</span> <span class="n">arch</span>  <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'resnet50'</span><span class="p">,</span><span class="s1">'resnet152'</span><span class="p">]:</span><span class="c1">#  ['vgg16','vgg19','vgg-f','googlenet']:</span>
            <span class="n">bs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arch</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'resnet50'</span><span class="p">,</span><span class="s1">'resnet152'</span><span class="p">]:</span>
            <span class="n">bs</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Architecture type not supported. Please choose one from the following </span><span class="si">{</span><span class="n">archs</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bs</span><span class="o">=</span><span class="mi">8</span> <span class="c1"># OOM Error</span>
    <span class="k">return</span> <span class="n">bs</span>

<span class="n">get_bs</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>32</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span><span class="o">=</span><span class="n">model_dict</span><span class="p">[</span><span class="n">arch</span><span class="p">](</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>ResNet(
  (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
  (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (relu): ReLU(inplace=True)
  (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
  (layer1): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer2): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (3): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer3): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (3): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (4): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (5): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer4): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (avgpool): AdaptiveAvgPool2d(output_size=(1, 1))
  (fc): Linear(in_features=2048, out_features=1000, bias=True)
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Other-Utils">
<a class="anchor" href="#Other-Utils" aria-hidden="true"><span class="octicon octicon-link"></span></a>Other Utils<a class="anchor-link" href="#Other-Utils"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">to_save</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">'checkpoint.pth'</span><span class="p">):</span>
    <span class="sd">"""Save checkpoint if a new best is achieved"""</span>
    <span class="k">if</span> <span class="n">to_save</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">"=&gt; Saving a new best"</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>  <span class="c1"># save checkpoint</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">"=&gt; Validation Accuracy did not improve"</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">save_perturbations</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">arch</span><span class="p">,</span><span class="n">epoch</span><span class="p">,</span><span class="n">wabdb_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">rand_str</span><span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">rand_str</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    

    
    <span class="n">perturbations</span><span class="o">=</span><span class="n">noise</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">*</span><span class="mi">255</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">rand_str</span><span class="si">}</span><span class="s1">/Perturbations_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">.npy'</span><span class="p">,</span> <span class="n">perturbations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">perturb_idx</span><span class="p">,</span><span class="n">perturbation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perturbations</span><span class="p">[:,]):</span>
        
        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">perturbation</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">wabdb_flag</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">"noise"</span><span class="p">:</span> <span class="p">[</span><span class="n">wandb</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Noise_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">perturb_idx</span><span class="si">}</span><span class="s2">"</span><span class="p">)]})</span>
        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">rand_str</span><span class="si">}</span><span class="s1">/Perturbations_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">perturb_idx</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>        

<span class="c1"># TODO </span>
<span class="k">def</span> <span class="nf">visualize_perturbations</span><span class="p">():</span>
    <span class="c1"># MAtplotlib Subplot ?</span>
    <span class="c1"># Subplots(4*4) or (3*3)</span>
    <span class="c1"># From Memory or Disk - Epoch number ?</span>
    <span class="k">pass</span>



<span class="k">def</span> <span class="nf">get_preds</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span><span class="n">return_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">idxs</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span><span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,:</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_idx</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">[:,</span><span class="n">idxs</span><span class="p">],</span> <span class="n">idxs</span>
    <span class="k">return</span>  <span class="n">predictions</span><span class="p">[:,</span><span class="n">idxs</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Validating-Model-Utils">
<a class="anchor" href="#Validating-Model-Utils" aria-hidden="true"><span class="octicon octicon-link"></span></a>Validating Model Utils<a class="anchor-link" href="#Validating-Model-Utils"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>
<span class="c1"># val_iterations = val_num/bs</span>

<span class="k">def</span> <span class="nf">compute_fooling_rate</span><span class="p">(</span><span class="n">prob_adv</span><span class="p">,</span><span class="n">prob_real</span><span class="p">):</span>
    <span class="sd">'''Helper function to calculate mismatches in the top index vector</span>
<span class="sd">     for clean and adversarial batch</span>
<span class="sd">     Parameters:</span>
<span class="sd">     prob_adv : Index vector for adversarial batch</span>
<span class="sd">     prob_real : Index vector for clean batch</span>
<span class="sd">     Returns:</span>
<span class="sd">     Number of mismatch and its percentage</span>
<span class="sd">    '''</span>
    <span class="n">nfool</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">prob_real</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prob_real</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="n">prob_adv</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">nfool</span> <span class="o">=</span> <span class="n">nfool</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">nfool</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">nfool</span><span class="p">)</span><span class="o">/</span><span class="n">size</span>      


<span class="k">def</span> <span class="nf">validate_generator_old</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">val_dl</span><span class="p">,</span><span class="n">val_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    
    <span class="n">total_fool</span><span class="o">=</span><span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"############### VALIDATION PHASE STARTED ################"</span><span class="p">)</span>
    <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s2">"############### VALIDATION PHASE STARTED ################"</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">val_iterations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_dl</span><span class="p">):</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1">#             labels = data[1].to(device)</span>
            
            <span class="n">prob_vec_clean</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">D_model</span><span class="p">(</span><span class="n">images</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Variable q</span>
            <span class="n">prob_vec_no_shuffle</span> <span class="o">=</span> <span class="n">D_model</span><span class="p">(</span><span class="n">images</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span>  
            <span class="n">nfool</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_fooling_rate</span><span class="p">(</span><span class="n">prob_vec_no_shuffle</span><span class="p">,</span><span class="n">prob_vec_clean</span><span class="p">)</span>
            <span class="n">total_fool</span> <span class="o">+=</span> <span class="n">nfool</span>
    
    
    <span class="n">fool_rate</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">total_fool</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">val_iterations</span><span class="o">*</span><span class="n">batch_size</span><span class="p">)</span>       
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fooling rate: </span><span class="si">{</span><span class="n">foolr</span><span class="si">}</span><span class="s2">. Total Items Fooled :</span><span class="si">{</span><span class="n">total_fool</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fooling rate: </span><span class="si">{</span><span class="n">foolr</span><span class="si">}</span><span class="s2">. Total Items Fooled :</span><span class="si">{</span><span class="n">total_fool</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    
    
<span class="k">def</span> <span class="nf">validate_generator</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">D_model</span><span class="p">,</span><span class="n">val_dl</span><span class="p">):</span>
    <span class="n">total_fool</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">val_dl</span><span class="p">),</span><span class="n">total</span> <span class="o">=</span> <span class="n">val_num</span><span class="o">//</span><span class="n">val_dl</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">val_images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">val_labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">prob_vec_clean</span><span class="p">,</span><span class="n">clean_idx</span> <span class="o">=</span> <span class="n">get_preds</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">D_model</span><span class="p">(</span><span class="n">val_images</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">return_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Variable q</span>
        <span class="n">prob_vec_no_shuffle</span><span class="p">,</span><span class="n">adv_idx</span> <span class="o">=</span> <span class="n">get_preds</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">D_model</span><span class="p">(</span><span class="n">val_images</span> <span class="o">+</span> <span class="n">noise</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">return_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
        <span class="n">nfool</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_fooling_rate</span><span class="p">(</span><span class="n">adv_idx</span><span class="p">,</span><span class="n">clean_idx</span><span class="p">)</span>
        <span class="n">total_fool</span> <span class="o">+=</span> <span class="n">nfool</span>

    <span class="n">fool_rate</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">total_fool</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">val_num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fool_rate</span><span class="p">,</span><span class="n">total_fool</span>


    
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Setup-Wandb">
<a class="anchor" href="#Setup-Wandb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup Wandb<a class="anchor-link" href="#Setup-Wandb"> </a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fit-and-Train-the-Generator">
<a class="anchor" href="#Fit-and-Train-the-Generator" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fit and Train the Generator<a class="anchor-link" href="#Fit-and-Train-the-Generator"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">nb_epochs</span><span class="p">,</span><span class="n">D_model</span><span class="p">,</span><span class="n">dls</span><span class="p">,</span><span class="n">optimizer</span><span class="p">,</span><span class="n">adversarygen</span><span class="o">=</span><span class="n">adversarygen</span><span class="p">):</span>
    <span class="c1"># Set the Discriminator in Eval mode; Weights are fixed.</span>
    <span class="n">train_dl</span><span class="p">,</span><span class="n">val_dl</span> <span class="o">=</span> <span class="n">dls</span>
    <span class="n">D_model</span><span class="o">=</span><span class="n">D_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">D_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2">%b%Y_%H_%M"</span><span class="p">)</span>
    <span class="n">train_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">'train_log_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.txt'</span><span class="p">,</span><span class="s1">'w'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_epochs</span><span class="p">),</span><span class="n">total</span><span class="o">=</span><span class="n">nb_epochs</span><span class="p">):</span>
        <span class="n">running_loss</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">rand_str</span><span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        
        <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">"############### TRAIN PHASE STARTED : </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">################"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dl</span><span class="p">),</span><span class="n">total</span> <span class="o">=</span> <span class="n">train_num</span><span class="o">//</span><span class="n">train_dl</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Move Data and Labels to device(GPU)</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            
            <span class="c1"># Generate the Adversarial Noise from Uniform Distribution U[-1,1]</span>
            <span class="n">latent_seed</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># (r1 - r2) * torch.rand(a, b) + r2</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">adversarygen</span><span class="p">(</span><span class="n">latent_seed</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="c1"># XB = images</span>
            <span class="c1">#preds_XB = f(images)</span>
            <span class="n">prob_vec_clean</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">D_model</span><span class="p">(</span><span class="n">images</span><span class="p">),</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Variable q</span>
            <span class="n">clean_preds</span> <span class="p">,</span><span class="n">clean_idx</span> <span class="o">=</span> <span class="n">get_preds</span><span class="p">(</span><span class="n">prob_vec_clean</span><span class="p">,</span><span class="n">return_idx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1">#XA = images+noise</span>
            <span class="c1">#preds_XA = f(images + noise)</span>
            <span class="n">prob_vec_no_shuffle</span> <span class="o">=</span> <span class="n">D_model</span><span class="p">(</span><span class="n">images</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span>  
            <span class="n">qc_</span> <span class="o">=</span>  <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">prob_vec_no_shuffle</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">clean_idx</span><span class="p">)</span> <span class="c1"># Variable q'c</span>

            <span class="c1"># 1. fooling_objective: encourages G to generate perturbations that decrease confidence of benign predictions</span>
            <span class="n">fool_obj</span><span class="p">,</span> <span class="n">mean_qc_</span> <span class="o">=</span> <span class="n">fooling_objective</span><span class="p">(</span><span class="n">qc_</span><span class="p">)</span>
            <span class="c1"># Perturbations  are shuffled across the batch dimesion to improve diversity</span>
            <span class="c1">#XS = images+ noise[torch.randperm(bs)]</span>
            <span class="n">prob_vec_shuffled</span> <span class="o">=</span>   <span class="n">D_model</span><span class="p">(</span><span class="n">images</span> <span class="o">+</span> <span class="n">noise</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">bs</span><span class="p">)])</span>
            
            <span class="c1"># 2.  encourages Generator to explore the space of perturbations and generate a diverse set of perturbations</span>
            <span class="n">divesity_obj</span><span class="o">=</span><span class="n">diversity_objective</span><span class="p">(</span><span class="n">prob_vec_no_shuffle</span><span class="p">,</span> <span class="n">prob_vec_shuffled</span><span class="p">)</span>

            <span class="c1"># Compute Total Loss</span>
            <span class="n">total_loss</span> <span class="o">=</span> <span class="n">divesity_obj</span> <span class="o">+</span> <span class="n">fool_obj</span>
            
            <span class="c1"># Lets perform Backpropagation to compute Gradients and update the weights</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            
            <span class="c1"># wandb Logging : Expensive : Logs Perturbation Images each iteration</span>
<span class="c1">#             perturbations=noise.permute(0,2,3,1).cpu().detach().numpy()*255</span>
<span class="c1">#             for perturb_idx,perturbation in enumerate(perturbations[:,]):</span>
<span class="c1">#                 im = Image.fromarray(perturbation.astype(np.uint8))</span>
<span class="c1">#                 wandb.log({"noise": [wandb.Image(im, caption=f"Noise_{arch}_{epoch}_{perturb_idx}")]})</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s2">"fool_obj"</span><span class="p">:</span> <span class="n">fool_obj</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                       <span class="s2">"divesity_obj"</span><span class="p">:</span> <span class="n">divesity_obj</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                       <span class="s2">"total_loss"</span><span class="p">:</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                      <span class="p">})</span>        
            
            <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">batch_idx</span><span class="o">!=</span><span class="mi">0</span>  <span class="ow">and</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span><span class="mi">0</span> <span class="p">:</span>
                <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">"############### VALIDATION PHASE STARTED : </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, Step : </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">batch_idx</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2"> ################"</span><span class="p">)</span>
                <span class="n">fool_rate</span><span class="p">,</span><span class="n">total_fool</span><span class="o">=</span> <span class="n">validate_generator</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">D_model</span><span class="p">,</span><span class="n">val_dl</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fooling rate: </span><span class="si">{</span><span class="n">fool_rate</span><span class="si">}</span><span class="s2">. Total Items Fooled :</span><span class="si">{</span><span class="n">total_fool</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fooling rate: </span><span class="si">{</span><span class="n">fool_rate</span><span class="si">}</span><span class="s2">. Total Items Fooled :</span><span class="si">{</span><span class="n">total_fool</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Diversity Loss :</span><span class="si">{</span><span class="n">divesity_obj</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> Fooling Loss: </span><span class="si">{</span><span class="n">fool_obj</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Total Loss after Epoch No: </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">running_loss</span><span class="o">/</span><span class="p">(</span><span class="n">train_num</span><span class="o">//</span><span class="n">train_dl</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">train_log</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Loss after Epoch No: </span><span class="si">{</span><span class="n">epoch</span> <span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">running_loss</span><span class="o">/</span><span class="p">(</span><span class="n">train_num</span><span class="o">//</span><span class="n">train_dl</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1"># to_save can be any expression/condition that returns a bool</span>
        
        <span class="n">save_checkpoint</span><span class="p">(</span><span class="n">adversarygen</span><span class="p">,</span> <span class="n">to_save</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">'GeneratorW_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rand_str</span><span class="si">}</span><span class="s1">.pth'</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="c1">#             save_perturbations(noise,arch,epoch)</span>
            <span class="n">save_perturbations</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span><span class="n">arch</span><span class="p">,</span><span class="n">epoch</span><span class="p">,</span><span class="n">wabdb_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">train_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Start-Actual-Trainning">
<a class="anchor" href="#Start-Actual-Trainning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start Actual Trainning<a class="anchor-link" href="#Start-Actual-Trainning"> </a>
</h1>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">total_epochs</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="c1"># Setting up Dataloaders</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">gc</span>

<span class="n">arch</span><span class="o">=</span><span class="s1">'resnet50'</span>
<span class="n">start</span><span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training Generator for Arch </span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">model</span><span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="n">arch</span><span class="p">](</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">get_bs</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
<span class="n">train_dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_dl</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">data_valid</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_dl</span><span class="p">,</span><span class="n">val_dl</span><span class="p">]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">adversarygen</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Elsasped Time </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="si">}</span><span class="s2"> Seconds"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Training Generator for Arch resnet50
32
Elsasped Time 0.6291134357452393 Seconds
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fit</span><span class="p">(</span><span class="n">nb_epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span><span class="n">D_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="n">dls</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/ubuntu/miniconda3/envs/pytorch/lib/python3.7/site-packages/ipykernel_launcher.py:8: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0
Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`
  
/home/ubuntu/miniconda3/envs/pytorch/lib/python3.7/site-packages/ipykernel_launcher.py:13: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0
Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`
  del sys.path[0]
/home/ubuntu/miniconda3/envs/pytorch/lib/python3.7/site-packages/ipykernel_launcher.py:45: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0
Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
Fooling rate: 99.126. Total Items Fooled :49563

Fooling rate: 99.506. Total Items Fooled :49753

Fooling rate: 99.364. Total Items Fooled :49682

Diversity Loss :0.9992280602455139 
 Fooling Loss: 0.03950555995106697 

Total Loss after Epoch No: 1 - 1.0430664758269603
=&gt; Saving a new best

Fooling rate: 99.332. Total Items Fooled :49666

Fooling rate: 99.486. Total Items Fooled :49743

Fooling rate: 98.67. Total Items Fooled :49335

Diversity Loss :0.9981168508529663 
 Fooling Loss: 0.02838512323796749 

Total Loss after Epoch No: 2 - 1.039582596757473
=&gt; Saving a new best

Fooling rate: 99.446. Total Items Fooled :49723

Fooling rate: 99.52. Total Items Fooled :49760

Fooling rate: 99.38. Total Items Fooled :49690

Diversity Loss :0.9990019798278809 
 Fooling Loss: 0.004721864592283964 

Total Loss after Epoch No: 3 - 1.039885509854708
=&gt; Saving a new best

Fooling rate: 99.356. Total Items Fooled :49678

Fooling rate: 99.658. Total Items Fooled :49829

Fooling rate: 99.662. Total Items Fooled :49831

Diversity Loss :0.999189555644989 
 Fooling Loss: 0.003563906066119671 

Total Loss after Epoch No: 4 - 1.0383393155076566
=&gt; Saving a new best

Fooling rate: 99.62. Total Items Fooled :49810

Fooling rate: 99.486. Total Items Fooled :49743

Fooling rate: 99.686. Total Items Fooled :49843

Diversity Loss :0.9990421533584595 
 Fooling Loss: 0.008808250539004803 

Total Loss after Epoch No: 5 - 1.0367735035908527
=&gt; Saving a new best

Fooling rate: 99.744. Total Items Fooled :49872

Fooling rate: 99.338. Total Items Fooled :49669

Fooling rate: 99.692. Total Items Fooled :49846

Diversity Loss :0.9993197917938232 
 Fooling Loss: 0.005549242720007896 

Total Loss after Epoch No: 6 - 1.037304274737835
=&gt; Saving a new best

Fooling rate: 99.494. Total Items Fooled :49747

Fooling rate: 99.422. Total Items Fooled :49711

Fooling rate: 99.454. Total Items Fooled :49727

Diversity Loss :0.9981052875518799 
 Fooling Loss: 0.04303847253322601 

Total Loss after Epoch No: 7 - 1.038387955763401
=&gt; Saving a new best

Fooling rate: 99.29. Total Items Fooled :49645

Fooling rate: 99.416. Total Items Fooled :49708

Fooling rate: 99.558. Total Items Fooled :49779

Diversity Loss :0.998153567314148 
 Fooling Loss: 6.139297056506621e-06 

Total Loss after Epoch No: 8 - 1.0364860896116648
=&gt; Saving a new best

Fooling rate: 99.59. Total Items Fooled :49795

Fooling rate: 99.78. Total Items Fooled :49890

Fooling rate: 99.444. Total Items Fooled :49722

Diversity Loss :0.998258113861084 
 Fooling Loss: 0.002013623248785734 

Total Loss after Epoch No: 9 - 1.0362467425755966
=&gt; Saving a new best

Fooling rate: 99.598. Total Items Fooled :49799

Fooling rate: 99.486. Total Items Fooled :49743

Fooling rate: 99.456. Total Items Fooled :49728

Diversity Loss :0.9985426664352417 
 Fooling Loss: 0.008954382501542568 

Total Loss after Epoch No: 10 - 1.038268227989857
=&gt; Saving a new best

Fooling rate: 99.72. Total Items Fooled :49860

Fooling rate: 99.426. Total Items Fooled :49713

Fooling rate: 99.692. Total Items Fooled :49846

Diversity Loss :0.9976068735122681 
 Fooling Loss: 0.020556485280394554 

Total Loss after Epoch No: 11 - 1.0406007697949042
=&gt; Saving a new best

Fooling rate: 99.436. Total Items Fooled :49718

Fooling rate: 99.63. Total Items Fooled :49815

Fooling rate: 99.554. Total Items Fooled :49777

Diversity Loss :0.9977318048477173 
 Fooling Loss: 0.04298632964491844 

Total Loss after Epoch No: 12 - 1.0370476129345405
=&gt; Saving a new best

Fooling rate: 99.498. Total Items Fooled :49749

Fooling rate: 99.562. Total Items Fooled :49781

Fooling rate: 99.458. Total Items Fooled :49729

Diversity Loss :0.9988154172897339 
 Fooling Loss: 0.04159717634320259 

Total Loss after Epoch No: 13 - 1.037070428713774
=&gt; Saving a new best

Fooling rate: 99.368. Total Items Fooled :49684

Fooling rate: 99.644. Total Items Fooled :49822

Fooling rate: 99.446. Total Items Fooled :49723

Diversity Loss :0.9994094371795654 
 Fooling Loss: 0.0624578632414341 

Total Loss after Epoch No: 14 - 1.0377162058766072
=&gt; Saving a new best

Fooling rate: 99.696. Total Items Fooled :49848

Fooling rate: 99.788. Total Items Fooled :49894

Fooling rate: 99.494. Total Items Fooled :49747

Diversity Loss :0.9997531175613403 
 Fooling Loss: 0.035558152943849564 

Total Loss after Epoch No: 15 - 1.0360386572205103
=&gt; Saving a new best

Fooling rate: 99.678. Total Items Fooled :49839

Fooling rate: 99.574. Total Items Fooled :49787

Fooling rate: 99.548. Total Items Fooled :49774

Diversity Loss :0.9999127388000488 
 Fooling Loss: 0.07229295372962952 

Total Loss after Epoch No: 16 - 1.041024495011721
=&gt; Saving a new best

Fooling rate: 99.7. Total Items Fooled :49850

Fooling rate: 99.542. Total Items Fooled :49771

Fooling rate: 99.654. Total Items Fooled :49827

Diversity Loss :0.9986363649368286 
 Fooling Loss: 0.0533723421394825 

Total Loss after Epoch No: 17 - 1.0388616713193746
=&gt; Saving a new best

Fooling rate: 99.634. Total Items Fooled :49817

Fooling rate: 99.78. Total Items Fooled :49890

Fooling rate: 99.24. Total Items Fooled :49620

Diversity Loss :0.9978522658348083 
 Fooling Loss: 0.03446746990084648 

Total Loss after Epoch No: 18 - 1.0345487464696934
=&gt; Saving a new best

Fooling rate: 99.37. Total Items Fooled :49685

Fooling rate: 99.69. Total Items Fooled :49845

Fooling rate: 99.492. Total Items Fooled :49746

Diversity Loss :0.9980953335762024 
 Fooling Loss: 0.04048139601945877 

Total Loss after Epoch No: 19 - 1.0351752294943883
=&gt; Saving a new best

Fooling rate: 99.674. Total Items Fooled :49837

Fooling rate: 99.714. Total Items Fooled :49857

Fooling rate: 99.434. Total Items Fooled :49717

Diversity Loss :0.9989607334136963 
 Fooling Loss: 0.021351832896471024 

Total Loss after Epoch No: 20 - 1.0392777105936637
=&gt; Saving a new best

</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Misc:">
<a class="anchor" href="#Misc:" aria-hidden="true"><span class="octicon octicon-link"></span></a>Misc:<a class="anchor-link" href="#Misc:"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Setup-Caffenet-and-VGG-F--(TODO)">
<a class="anchor" href="#Setup-Caffenet-and-VGG-F--(TODO)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup Caffenet and VGG-F  (TODO)<a class="anchor-link" href="#Setup-Caffenet-and-VGG-F--(TODO)"> </a>
</h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Paper  : <a href="http://www.robots.ox.ac.uk/~vgg/publications/2015/Parkhi15/parkhi15.pdf">http://www.robots.ox.ac.uk/~vgg/publications/2015/Parkhi15/parkhi15.pdf</a>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Run-the-below-code-first-before-loading-VGG-F">
<a class="anchor" href="#Run-the-below-code-first-before-loading-VGG-F" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run the below code first before loading VGG-F<a class="anchor-link" href="#Run-the-below-code-first-before-loading-VGG-F"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!{</span>sys.executable<span class="o">}</span> PrepareCaffenetModel.py
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Loading-VGG-F">
<a class="anchor" href="#Loading-VGG-F" aria-hidden="true"><span class="octicon octicon-link"></span></a>Loading VGG-F<a class="anchor-link" href="#Loading-VGG-F"> </a>
</h4>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#collapse-hide</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">vgg</span> <span class="kn">import</span> <span class="n">VGG_F</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">vgg_f</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'VGG_FACE.caffemodel.pt'</span><span class="p">))</span>
<span class="n">model_dict</span><span class="p">[</span><span class="s1">'vgg-f'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">model</span>

<span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Downloading-Trained-Weights">
<a class="anchor" href="#Downloading-Trained-Weights" aria-hidden="true"><span class="octicon octicon-link"></span></a>Downloading Trained Weights<a class="anchor-link" href="#Downloading-Trained-Weights"> </a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Pretrained Generator Weigths for Googlenet, Resnet50, VGG16 and VGG19 Avalaible as a Kaggle Dataset</li>
<li>Link : <a href="https://www.kaggle.com/gokkulnath/nag-pytorch-pretrained">https://www.kaggle.com/gokkulnath/nag-pytorch-pretrained</a>
</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Uncomment the below line after setting up kaggle api key</span>
<span class="c1"># !kaggle datasets download -d gokkulnath/nag-pytorch-pretrained</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluating-NAG-performance-across-Models:-(TODO)">
<a class="anchor" href="#Evaluating-NAG-performance-across-Models:-(TODO)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Evaluating NAG performance across Models: (TODO)<a class="anchor-link" href="#Evaluating-NAG-performance-across-Models:-(TODO)"> </a>
</h3>
<ul>
<li>For Tabular Column Generation</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Steps to evaluate the perturbations generated by Generator Network (TODO)</p>

<pre><code>arch='Fixed'
for modelarch, model in model_dict.items():
    num_iteration = 10 # Blackbox Settings
    if modelarch == arch:
        num_iteration =100 # Whitebox Settings 
    for i range(num_iteration)
        1. Load the Weights of the Generator
        2. Generate a Perturbation using a random vector of dimension latent_dim,1
        3. Add the noise to a sample image</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Interpolating-Latent-Dimension-for-NAG">
<a class="anchor" href="#Interpolating-Latent-Dimension-for-NAG" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interpolating Latent Dimension for NAG<a class="anchor-link" href="#Interpolating-Latent-Dimension-for-NAG"> </a>
</h3>
<p>
</p>
<center>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/2lojORAu8vA" frameborder="0" allowfullscreen=""></iframe>
</center>


</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Obtained-Perturbations">
<a class="anchor" href="#Obtained-Perturbations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Obtained Perturbations<a class="anchor-link" href="#Obtained-Perturbations"> </a>
</h1>
<p><img src="/adversarialwilderness/images/copied_from_nb/resources/Collage_perturbation.v1.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References:">
<a class="anchor" href="#References:" aria-hidden="true"><span class="octicon octicon-link"></span></a>References:<a class="anchor-link" href="#References:"> </a>
</h2>
<ul>
<li>Official Code Repo : <a href="https://github.com/val-iisc/nag">https://github.com/val-iisc/nag</a>
</li>
<li>GAN Architecture : Pytorch Tutorial</li>
<li><a href="https://pytorch.org/docs/stable/nn.html?highlight=convtranspose2d#torch.nn.ConvTranspose2d">Transpose Convolution Docs</a></li>
</ul>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="Gokkulnath/adversarialwilderness"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/adversarialwilderness/adversarial%20machine%20learning/2020/03/30/Network-Adversary-Generation.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/adversarialwilderness/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/adversarialwilderness/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/adversarialwilderness/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Thoughts, stories and ideas. ~Gokkulnath</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/gokkulnath" title="gokkulnath"><svg class="svg-icon grey"><use xlink:href="/adversarialwilderness/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/gokkulnath" title="gokkulnath"><svg class="svg-icon grey"><use xlink:href="/adversarialwilderness/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
